name: Commit CI

on:
    push:
        # only trigger on branches, not on tags
        branches: '**'

# Stop previous runs when new commit is pushed into the MR
concurrency:
    group: test-${{ github.ref }}
    cancel-in-progress: true

env:
    DEBIAN_FRONTEND: noninteractive
    NODE_VERSION: 20.x

defaults:
    run:
        shell: bash

jobs:
    format-check:
        name: Tests & Lint & Format check
        runs-on: ubuntu-slim
        timeout-minutes: 15
        continue-on-error: true
        steps:
            - name: Checkout
              uses: actions/checkout@v5

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}

            - name: Setup cache
              uses: actions/cache@v4
              with:
                  path: |
                      node_modules
                      ~/.npm
                  key: ${{ runner.os }}-node-${{ env.NODE_VERSION }}-${{ hashFiles('package-lock.json') }}
                  restore-keys: |
                      ${{ runner.os }}-node-${{ env.NODE_VERSION }}-

            - name: Install dependencies
              run: npm install --no-audit

            - name: Build
              run: npm run build

            - name: Run unit tests
              run: npm run test

            - name: Run lint check
              run: npm run lint:check

            - name: Run format check
              run: npm run format:check